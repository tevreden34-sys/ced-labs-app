<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cedric Trade Hub</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{--bg:#0b1020;--card:#121a2b;--line:#273452;--text:#eaf1ff;--muted:#9fb0d6;--green:#19c37d;--red:#ff5d7a;--yellow:#ffcb66}
    *{box-sizing:border-box} body{margin:0;background:radial-gradient(1000px 500px at 20% -10%,#1a2743 0%,transparent 40%),var(--bg);color:var(--text);font-family:Inter,system-ui,Arial,sans-serif}
    .wrap{max-width:1400px;margin:0 auto;padding:20px}
    h1{margin:0 0 4px;font-size:30px}.sub{margin:0 0 16px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:1.4fr .9fr;gap:14px}
    .card{background:linear-gradient(180deg,var(--card),#0f1627);border:1px solid var(--line);border-radius:16px;overflow:hidden}
    .head{padding:12px 14px;border-bottom:1px solid #1f2b45;display:flex;justify-content:space-between;align-items:center}
    .body{padding:12px 14px}
    .kpis{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:10px;margin-bottom:14px}
    .kpi{background:#0f172b;border:1px solid #22314f;border-radius:12px;padding:10px}
    .kpi .l{font-size:12px;color:var(--muted)} .kpi .v{font-weight:700;font-size:18px;margin-top:4px}
    .up{color:var(--green)} .down{color:var(--red)} .warn{color:var(--yellow)}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .tfbtn{padding:4px 8px;font-size:11px;border-radius:8px;border:1px solid #2d3d61;background:#111a30;color:#cfe0ff;cursor:pointer}
    .tfbtn.active{background:#1e3258;border-color:#4d76b8;color:#fff}
    select,button,input[type=range]{background:#111a30;color:var(--text);border:1px solid #2d3d61;border-radius:10px;padding:8px 10px}
    button{cursor:pointer}
    .danger{background:#3a0f1a;border-color:#7a2137;color:#ffdce5}
        .tiny{font-size:12px;color:var(--muted)}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .bookCol h4{margin:0 0 8px;font-size:13px;color:#b8c9ea}
    .bookTable{width:100%;border-collapse:collapse;font-size:10px}
    .bookTable td{padding:2px 4px;border-bottom:1px solid #1c2a45}
    .bookTable td:last-child{text-align:right}
    .ask td{color:#ff9bae}.bid td{color:#8effc8}
    .tradeWrap{margin-top:10px}
    .tradeScroller{width:100%;max-height:280px;overflow:auto;border:1px solid #1c2a45;border-radius:10px}
    .tradeTable{width:100%;min-width:1020px;table-layout:fixed;border-collapse:collapse;font-size:11px}
    .tradeTable th,.tradeTable td{padding:6px 7px;border-bottom:1px solid #1c2a45;text-align:left;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .tradeTable th{color:#9fb0d6;font-weight:600}
    .tradeTable thead th{position:sticky;top:0;background:#0f172b;z-index:1}
    .tradeTable th:nth-child(1){width:84px}.tradeTable th:nth-child(2){width:62px}.tradeTable th:nth-child(3){width:88px}.tradeTable th:nth-child(4){width:62px}.tradeTable th:nth-child(5){width:56px}.tradeTable th:nth-child(6){width:88px}.tradeTable th:nth-child(7){width:84px}.tradeTable th:nth-child(8){width:104px}.tradeTable th:nth-child(9){width:84px}
    .hlcrop{width:100%;height:520px;border:1px solid #1f2f50;border-radius:10px;background:#0b1326;overflow:hidden;position:relative;margin-bottom:10px}
    .hlframe{width:100%;height:900px;border:0;transform:translateY(-80px);pointer-events:auto}
        @media(max-width:980px){.grid{grid-template-columns:1fr}.kpis{grid-template-columns:repeat(3,minmax(0,1fr))}.split{grid-template-columns:1fr}}
    @media(max-width:600px){.kpis{grid-template-columns:repeat(2,minmax(0,1fr))}}
  </style>
</head>
<body>
  <main class="wrap">
    <h1>Cedric Trade Hub</h1>
    <p class="sub">Paper bot · 10,000 USDT start · leverage up to 70x · TP1 at 1.5R (85% close) · SL at -1R then breakeven</p>

    <div class="kpis">
      <div class="kpi"><div class="l">Symbol</div><div class="v" id="sym">BTCUSDT</div></div>
      <div class="kpi"><div class="l">Price</div><div class="v" id="price">-</div></div>
      <div class="kpi"><div class="l">Signal</div><div class="v" id="signal">-</div></div>
      <div class="kpi"><div class="l">Balance</div><div class="v" id="balance">$10,000.00</div></div>
            <div class="kpi"><div class="l">Unrealized PnL</div><div class="v" id="upnl">$0.00</div></div>
      <div class="kpi"><div class="l">Margin in Use</div><div class="v" id="marginUsed">$0.00</div></div>
          </div>

    <section class="grid">
      <article class="card">
        <div class="head"><b>Live Coin Chart + Order Book</b><span id="updated" class="sub" style="margin:0">interactive chart enabled</span></div>
        <div class="body">
                    <div class="hlcrop"><iframe id="hlChart" class="hlframe" src="https://app.hyperliquid.xyz/trade/BTC" loading="lazy" referrerpolicy="no-referrer"></iframe></div>
          <div class="split" style="margin-top:12px">
            <div class="bookCol">
              <h4>Asks (Top 5)</h4>
              <table class="bookTable" id="asks"></table>
            </div>
            <div class="bookCol">
              <h4>Bids (Top 5)</h4>
              <table class="bookTable" id="bids"></table>
            </div>
          </div>

        </div>
      </article>

      <article class="card">
        <div class="head"><b>Bot Control</b></div>
        <div class="body">
          <div class="controls" style="margin-bottom:8px">
            <select id="symbol"><option>BTCUSDT</option><option>ETHUSDT</option><option>SOLUSDT</option><option>BNBUSDT</option></select>
            <label class="tiny">Auto TF: <span id="tfVal">-</span></label>
            <label class="tiny">Auto Lev (5-70x): <span id="levVal">-</span></label>
            <button id="start">Start</button>
            <button id="stop">Stop</button>
            <button id="panic" class="danger">Panic Sell</button>
            <button id="reset">Reset</button>
          </div>
          <div class="tiny" style="margin:10px 0 6px">Performance Chart</div>
          <canvas id="equityChart" height="140"></canvas>
          <div class="tradeWrap" style="margin-top:12px">
            <h4 style="margin:0 0 6px;font-size:13px;color:#b8c9ea">Trade Book</h4>
            <div class="tradeScroller"><table class="tradeTable">
              <thead><tr><th>Time</th><th>Type</th><th>Pair</th><th>Side</th><th>Lev</th><th>Price</th><th>Qty</th><th>Size $</th><th>PnL</th></tr></thead>
              <tbody id="tradeBook"><tr><td colspan="9" class="tiny">No trades yet. Start bot to generate orders.</td></tr></tbody>
            </table></div>
          <div class="tiny" style="margin:8px 0 4px">Trade Notes</div>
          <div id="tradeNotes" class="tiny" style="background:#0b1326;border:1px solid #1c2a45;border-radius:10px;padding:8px;max-height:110px;overflow:auto">No trade notes yet.</div>
          </div>
        </div>
      </article>
    </section>
  </main>

<script>
(() => {
  const $ = id => document.getElementById(id);
  const RISK_PCT = 0.01;
  const TP1_R = 1.5;
  const TP1_CLOSE = 0.85;
  const TRADE_SYMBOLS = ['BTCUSDT','ETHUSDT','SOLUSDT','BNBUSDT'];

  let running = false;
  let tickTimer = null;
  let marketTimer = null;
  let tradeHistory = [];

  let state = {
    balance: 10000,
    positions: {}, // sym -> {side,qty,entry,sl,tp1,tp1Hit,lev}
    trades: 0,
    equity: [10000],
    labels: ['start'],
    autoTfBySym: Object.fromEntries(TRADE_SYMBOLS.map(s=>[s,'5m'])),
    autoLevBySym: Object.fromEntries(TRADE_SYMBOLS.map(s=>[s,10])),
    signalBySym: Object.fromEntries(TRADE_SYMBOLS.map(s=>[s,'HOLD'])),
    priceBySym: Object.fromEntries(TRADE_SYMBOLS.map(s=>[s,0])),
    chartTf: '5m'
  };

  const chart = new Chart($('equityChart').getContext('2d'), {
    type: 'line',
    data: { labels: state.labels, datasets: [{ label: 'Equity', data: state.equity, borderColor: '#5aa8ff', backgroundColor: 'rgba(90,168,255,.15)', fill: true, tension: .25, pointRadius: 0 }]},
    options: { responsive: true, plugins: { legend: { display:false }}, scales: { x: { display:false }, y: { ticks: { color:'#9fb0d6' }, grid:{ color:'rgba(255,255,255,.06)' }}}}
  });

  function fmt(v){ return '$'+Number(v).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }
  function log(msg){ return; }
  function ema(arr, p){ const k=2/(p+1); let v=arr[0]; for(let i=1;i<arr.length;i++) v=arr[i]*k+v*(1-k); return v; }
  function rsi(arr, p=14){ if(arr.length<p+1) return 50; let g=0,l=0; for(let i=arr.length-p;i<arr.length;i++){ const d=arr[i]-arr[i-1]; if(d>=0) g+=d; else l-=d; } if(l===0) return 100; const rs=(g/p)/(l/p); return 100-(100/(1+rs)); }

  function addTrade(type, symbol, side, price, qty, pnl, reason, lev){
    const _price = Number(price||0), _qty = Number(qty||0), _pnl = Number(pnl||0);
    tradeHistory.unshift({
      t:new Date().toLocaleTimeString(),
      type,
      symbol,
      side:side||'-',
      price:_price,
      qty:_qty,
      usdSize:_price*_qty,
      pnl:_pnl,
      reason:reason||'-',
      lev: Number(lev||0)
    });
    if(tradeHistory.length>40) tradeHistory = tradeHistory.slice(0,40);
    const tb = $('tradeBook'); if(!tb) return;
    tb.innerHTML = tradeHistory.map(r=>{
      const currentPx = state.priceBySym[r.symbol] || r.price || 0;
      const isOpen = r.type === 'OPEN';
      const rowPnl = isOpen
        ? ((r.side==='LONG' ? (currentPx - r.price) : (r.price - currentPx)) * (r.qty || 0))
        : (r.pnl || 0);
      const pnlText = (r.type==='OPEN' && !currentPx) ? '-' : fmt(rowPnl);
      const pnlCls = rowPnl>=0 ? 'up' : 'down';
      const qtyText = r.qty ? `${r.qty.toFixed(4)}` : '-';
      const usdNow = isOpen ? ((r.qty||0) * currentPx) : (r.usdSize || 0);
      const usdText = usdNow ? fmt(usdNow) : '-';
      const sideCls = r.side === 'LONG' ? 'up' : (r.side === 'SHORT' ? 'down' : '');
      return `<tr><td>${r.t}</td><td>${r.type}</td><td>${r.symbol}</td><td class="${sideCls}">${r.side}</td><td>${r.lev?`${r.lev}x`:'-'}</td><td>${r.price? r.price.toFixed(2):'-'}</td><td class="${pnlCls}">${qtyText}</td><td class="${pnlCls}">${usdText}</td><td class="${pnlCls}">${pnlText}</td></tr>`;
    }).join('');
    const notes = $('tradeNotes');
    if(notes){
      notes.innerHTML = tradeHistory.slice(0,12).map(r=>`[${r.t}] ${r.type} ${r.symbol} ${r.side} — ${r.reason}`).join('<br>') || 'No trade notes yet.';
    }
  }

  function renderBalance(v){ $('balance').textContent = fmt(v ?? state.balance); }

  function renderOrderBook(book){
    const asks = (book.asks || []).slice(0,5);
    const bids = (book.bids || []).slice(0,5);
    $('asks').innerHTML = asks.map(a=>`<tr class="ask"><td>${Number(a[0]).toFixed(2)}</td><td>${Number(a[1]).toFixed(4)}</td></tr>`).join('');
    $('bids').innerHTML = bids.map(b=>`<tr class="bid"><td>${Number(b[0]).toFixed(2)}</td><td>${Number(b[1]).toFixed(4)}</td></tr>`).join('');
  }

  async function fetchOrderBook(sym){
    try {
      const r = await fetch(`https://api.binance.com/api/v3/depth?symbol=${sym}&limit=10`, {cache:'no-store'});
      if(!r.ok) throw new Error('book');
      const d = await r.json();
      renderOrderBook(d);
    } catch {}
  }

  function chooseLeverage(close, rv, e20, e50){
    const tail = close.slice(-30), hi=Math.max(...tail), lo=Math.min(...tail);
    const volPct=((hi-lo)/Math.max(1e-9,lo))*100;
    const trendStrength=Math.abs((e20-e50)/Math.max(1e-9,e50))*100;
    let lev=10;
    if(volPct<0.6&&trendStrength>0.18) lev=35; else if(volPct<1.0&&trendStrength>0.12) lev=25; else if(volPct<1.8) lev=15; else lev=8;
    if(rv>75||rv<25) lev=Math.max(5,Math.floor(lev*0.7));
    // allow higher leverage on strongest setups
    if(volPct < 0.45 && trendStrength > 0.28 && Math.abs(rv-50) > 12) lev = Math.max(lev, 55);
    if(volPct < 0.30 && trendStrength > 0.40 && Math.abs(rv-50) > 18) lev = Math.max(lev, 70);
    return Math.max(5,Math.min(70,Math.round(lev)));
  }

  function chooseAllocationPct(close, rv, e20, e50){
    const tail = close.slice(-30), hi=Math.max(...tail), lo=Math.min(...tail);
    const volPct=((hi-lo)/Math.max(1e-9,lo))*100;
    const trendStrength=Math.abs((e20-e50)/Math.max(1e-9,e50))*100;
    let pct = 0.05; // default 5%
    if(trendStrength > 0.22 && volPct < 0.8) pct = 0.12;
    else if(trendStrength > 0.14 && volPct < 1.2) pct = 0.08;
    else if(volPct > 2.2) pct = 0.03;
    if(rv > 78 || rv < 22) pct *= 0.7;
    return Math.max(0.02, Math.min(0.15, pct));
  }

  function pickBestTimeframe(dataByTf){
    const tfs=['1m','5m','15m']; let best={tf:'5m',score:-1e9};
    for(const tf of tfs){
      const close=dataByTf[tf]; if(!close||close.length<60) continue;
      const e20=ema(close.slice(-80),20), e50=ema(close.slice(-120),50), rv=rsi(close,14);
      const tail=close.slice(-30), hi=Math.max(...tail), lo=Math.min(...tail);
      const volPct=((hi-lo)/Math.max(1e-9,lo))*100;
      const trend=Math.abs((e20-e50)/Math.max(1e-9,e50))*100;
      const momentum=Math.abs(rv-50)/50;
      const score=trend*1.4+momentum*0.8-volPct*0.25;
      if(score>best.score) best={tf,score};
    }
    return best.tf;
  }

  function calcEquity(){
    let eq = state.balance;
    for(const sym of TRADE_SYMBOLS){
      const p = state.positions[sym];
      if(!p) continue;
      const px = state.priceBySym[sym] || p.entry;
      const pnl = p.side==='LONG' ? (px-p.entry)*p.qty : (p.entry-px)*p.qty;
      eq += pnl;
    }
    return eq;
  }

  function calcUnrealizedPnl(){
    let u = 0;
    for(const sym of TRADE_SYMBOLS){
      const p = state.positions[sym];
      if(!p) continue;
      const px = state.priceBySym[sym] || p.entry;
      u += p.side==='LONG' ? (px-p.entry)*p.qty : (p.entry-px)*p.qty;
    }
    return u;
  }

  function calcMarginInUse(){
    let m = 0;
    for(const sym of TRADE_SYMBOLS){
      const p = state.positions[sym];
      if(!p) continue;
      m += Number(p.margin || 0);
    }
    return m;
  }


  function openPosition(sym, side, px, reason, lev, allocPct){
    if(state.positions[sym]) return;
    const margin = state.balance * allocPct;
    const notional = margin * lev;
    const qty = notional / px;
    const oneR = px * RISK_PCT;
    const pos = { side, qty, entry:px, lev, allocPct, margin, tp1Hit:false, sl:0, tp1:0 };
    if(side==='LONG'){ pos.sl=px-oneR; pos.tp1=px+(oneR*TP1_R); }
    else { pos.sl=px+oneR; pos.tp1=px-(oneR*TP1_R); }
    state.positions[sym]=pos;
    state.trades++;
    const notionalUsd = qty * px;
    log(`OPEN ${side} ${sym} @ ${px.toFixed(2)} | lev ${lev}x | size ${qty.toFixed(4)} ${sym.replace('USDT','')} (${fmt(notionalUsd)}) | alloc ${(allocPct*100).toFixed(1)}% | SL ${pos.sl.toFixed(2)} | TP1 ${pos.tp1.toFixed(2)} | ${reason}`);
    addTrade('OPEN', sym, side, px, qty, 0, reason, lev);
  }

  function closePosition(sym, px, reason){
    const p = state.positions[sym];
    if(!p) return;
    const pnl = p.side==='LONG' ? (px-p.entry)*p.qty : (p.entry-px)*p.qty;
    state.balance += pnl;
    renderBalance(state.balance);
    const closeNotional = p.qty * px;
    log(`CLOSE ${p.side} ${sym} @ ${px.toFixed(2)} | closed ${p.qty.toFixed(4)} ${sym.replace('USDT','')} (${fmt(closeNotional)}) | pnl ${pnl>=0?'+':''}${fmt(pnl)} | new balance ${fmt(state.balance)} | ${reason}`);
    addTrade('CLOSE', sym, p.side, px, p.qty, pnl, reason, p.lev);
    delete state.positions[sym];
    state.trades++;
  }

  function takePartial(sym, px){
    const p = state.positions[sym]; if(!p || p.tp1Hit) return;
    const closeQty = p.qty * TP1_CLOSE;
    const pnl = p.side==='LONG' ? (px-p.entry)*closeQty : (p.entry-px)*closeQty;
    state.balance += pnl;
    p.qty -= closeQty;
    p.tp1Hit = true;
    p.sl = p.entry;
    renderBalance(state.balance);
    const partialNotional = closeQty * px;
    log(`TP1 HIT ${sym} @ ${px.toFixed(2)} | closed 85% (${closeQty.toFixed(4)} ${sym.replace('USDT','')} / ${fmt(partialNotional)}) | realized ${pnl>=0?'+':''}${fmt(pnl)} | SL -> BE`);
    addTrade('TP1', sym, p.side, px, closeQty, pnl, 'Take 85% at 1.5R', p.lev);
  }

  function managePosition(sym, px){
    const p = state.positions[sym]; if(!p) return;
    if(!p.tp1Hit && ((p.side==='LONG'&&px>=p.tp1)||(p.side==='SHORT'&&px<=p.tp1))) takePartial(sym, px);
    if((p.side==='LONG'&&px<=p.sl)||(p.side==='SHORT'&&px>=p.sl)) closePosition(sym, px, p.tp1Hit?'breakeven stop after TP1':'-1R stop loss hit');
  }

  function updateFocusKpis(){
    const sym = $('symbol').value;
    const px = state.priceBySym[sym] || 0;
    const sig = state.signalBySym[sym] || 'HOLD';
    $('sym').textContent = sym;
    $('price').textContent = px ? fmt(px) : '-';
    $('signal').textContent = sig;
    $('signal').className = 'v '+(sig==='BUY'?'up':sig==='SELL'?'down':'warn');
    $('levVal').textContent = (state.autoLevBySym[sym] || 10) + 'x';
    $('tfVal').textContent = state.autoTfBySym[sym] || '5m';
  }

  async function refreshFocusedMarketView(){
    const sym = $('symbol').value;
    const base = sym.replace('USDT','');
    const frame = $('hlChart');
    if(frame && !frame.src.includes(`/trade/${base}`)) frame.src = `https://app.hyperliquid.xyz/trade/${base}`;
    try{
      const [pRes,bRes] = await Promise.all([
        fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${sym}`, {cache:'no-store'}),
        fetch(`https://api.binance.com/api/v3/depth?symbol=${sym}&limit=10`, {cache:'no-store'})
      ]);
      if(!pRes.ok || !bRes.ok) throw new Error('market view fetch failed');
      const px = Number((await pRes.json()).price);
      const book = await bRes.json();
      state.priceBySym[sym] = px;
      renderOrderBook(book);
      updateFocusKpis();
      $('updated').textContent = 'last tick: '+new Date().toLocaleTimeString();
    }catch(e){
      $('updated').textContent = 'last tick: '+new Date().toLocaleTimeString();
      updateFocusKpis();
    }
  }

  async function processSymbol(sym){
    const [k1,k5,k15,pRes] = await Promise.all([
      fetch(`https://api.binance.com/api/v3/klines?symbol=${sym}&interval=1m&limit=140`, {cache:'no-store'}),
      fetch(`https://api.binance.com/api/v3/klines?symbol=${sym}&interval=5m&limit=140`, {cache:'no-store'}),
      fetch(`https://api.binance.com/api/v3/klines?symbol=${sym}&interval=15m&limit=140`, {cache:'no-store'}),
      fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${sym}`, {cache:'no-store'}),
    ]);
    if(!k1.ok || !k5.ok || !k15.ok || !pRes.ok) throw new Error('market fetch failed '+sym);

    const byTf = {
      '1m': (await k1.json()).map(c=>Number(c[4])),
      '5m': (await k5.json()).map(c=>Number(c[4])),
      '15m': (await k15.json()).map(c=>Number(c[4]))
    };
    const px = Number((await pRes.json()).price);
    state.priceBySym[sym] = px;

    const tf = pickBestTimeframe(byTf);
    state.autoTfBySym[sym] = tf;
    const close = byTf[tf];

    const e20 = ema(close.slice(-80),20), e50 = ema(close.slice(-120),50), rv = rsi(close,14);
    const autoLev = chooseLeverage(close, rv, e20, e50);
    const allocPct = chooseAllocationPct(close, rv, e20, e50);
    state.autoLevBySym[sym] = autoLev;

    managePosition(sym, px);

    let sig='HOLD';
    if(e20>e50 && rv>53) sig='BUY';
    if(e20<e50 && rv<47) sig='SELL';
    state.signalBySym[sym]=sig;

    const reason = `TF ${tf}, EMA20 ${e20.toFixed(2)} vs EMA50 ${e50.toFixed(2)}, RSI ${rv.toFixed(1)}, autoLev ${autoLev}x, alloc ${(allocPct*100).toFixed(1)}%`; 
    const pos = state.positions[sym];

    if(sig==='BUY'){
      if(pos && pos.side==='SHORT') closePosition(sym, px, `trend flip bullish | ${reason}`);
      if(!state.positions[sym]) openPosition(sym, 'LONG', px, reason, autoLev, allocPct);
    } else if(sig==='SELL'){
      if(pos && pos.side==='LONG') closePosition(sym, px, `trend flip bearish | ${reason}`);
      if(!state.positions[sym]) openPosition(sym, 'SHORT', px, reason, autoLev, allocPct);
    }
  }

  async function tick(){
    if(!running) return;
    try{
      await Promise.all(TRADE_SYMBOLS.map(processSymbol));
      fetchOrderBook($('symbol').value);

      const eq = calcEquity();
      renderBalance(eq);
      state.equity.push(eq); state.labels.push(new Date().toLocaleTimeString());
      if(state.equity.length>220){ state.equity.shift(); state.labels.shift(); }
      chart.data.labels = state.labels;
      chart.data.datasets[0].data = state.equity;
      chart.update('none');

      updateFocusKpis();
      const upnl = calcUnrealizedPnl();
      $('upnl').textContent = (upnl>=0?'+':'') + fmt(upnl);
      $('upnl').className = 'v '+(upnl>=0?'up':'down');
      $('marginUsed').textContent = fmt(calcMarginInUse());
      $('marginUsed').className = 'v warn';
      $('updated').textContent = 'last tick: '+new Date().toLocaleTimeString();
    }catch(e){
      // silent retry
    }
    tickTimer = setTimeout(tick, 1000);
  }

  function startBot(){
    if(running) return;
    running = true;
    clearTimeout(tickTimer);
    log(`Bot started | initial balance ${fmt(state.balance)} | mode: multi-pair (${TRADE_SYMBOLS.join(', ')})`);
    tick();
  }

  function stopBot(msg='stopped manually'){
    running = false;
    clearTimeout(tickTimer);
    const openSyms = Object.keys(state.positions);
    for(const sym of openSyms){
      const px = state.priceBySym[sym] || state.positions[sym].entry;
      closePosition(sym, px, 'Stop pressed: forced close');
    }
    log(`Bot ${msg}`);
  }

  $('start').onclick = startBot;
  $('stop').onclick = () => stopBot('stopped manually');
  $('panic').onclick = () => {
    const prices = state.priceBySym;
    const openSyms = Object.keys(state.positions);
    if(!openSyms.length){ log('PANIC SELL clicked, but no open positions.'); return; }
    for(const sym of openSyms){
      const px = prices[sym] || state.positions[sym].entry;
      closePosition(sym, px, 'PANIC SELL manual emergency exit');
    }
  };

  $('reset').onclick = () => {
    stopBot('reset');
    state = {
      balance: 10000,
      positions: {},
      trades: 0,
      equity: [10000],
      labels: ['start'],
      autoTfBySym: Object.fromEntries(TRADE_SYMBOLS.map(s=>[s,'5m'])),
      autoLevBySym: Object.fromEntries(TRADE_SYMBOLS.map(s=>[s,10])),
      signalBySym: Object.fromEntries(TRADE_SYMBOLS.map(s=>[s,'HOLD'])),
      priceBySym: Object.fromEntries(TRADE_SYMBOLS.map(s=>[s,0])),
      chartTf: '5m'
    };
    tradeHistory=[]; if($('tradeBook')) $('tradeBook').innerHTML='<tr><td colspan="9" class="tiny">No trades yet. Start bot to generate orders.</td></tr>';
    chart.data.labels=state.labels; chart.data.datasets[0].data=state.equity; chart.update();
    $('upnl').textContent='$0.00'; $('marginUsed').textContent='$0.00'; $('signal').textContent='-'; $('price').textContent='-';
    renderBalance(state.balance); updateFocusKpis();
    log('State reset to initial 10,000 USDT balance.');
  };

  $('symbol').onchange = ()=>{ updateFocusKpis(); refreshFocusedMarketView(); };

  renderBalance(state.balance);
  $('tfVal').textContent = '5m';
  $('levVal').textContent = '10x';
  if($('marginUsed')) $('marginUsed').textContent = '$0.00';
  refreshFocusedMarketView();
  marketTimer = setInterval(refreshFocusedMarketView, 1000);
})();
</script>
</body>
</html>